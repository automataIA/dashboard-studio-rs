#!/bin/bash
# Pre-commit hook for Leptos 0.8 CSR project quality assurance
# This hook runs automatically before commits to ensure code quality

set -e  # Exit on any error

echo "ğŸ” Running pre-commit checks..."

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Track if any check failed
CHECKS_FAILED=0

# ============================================================================
# 1. Code Formatting Check
# ============================================================================
echo ""
echo "${BLUE}ğŸ“ Checking code formatting...${NC}"

if command -v leptosfmt &> /dev/null; then
    # Check if any Rust files are staged
    RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)

    if [ -n "$RUST_FILES" ]; then
        echo "  Checking leptosfmt on staged files..."
        for file in $RUST_FILES; do
            if [ -f "$file" ]; then
                leptosfmt --check --rustfmt "$file" || {
                    echo "${RED}âŒ Formatting issues found in $file${NC}"
                    echo "${YELLOW}   Fix with: leptosfmt --rustfmt $file${NC}"
                    CHECKS_FAILED=1
                }
            fi
        done

        if [ $CHECKS_FAILED -eq 0 ]; then
            echo "${GREEN}  âœ… leptosfmt formatting OK${NC}"
        fi
    else
        echo "${GREEN}  â­ï¸  No Rust files to check${NC}"
    fi
else
    echo "${YELLOW}  âš ï¸  leptosfmt not found. Install with: cargo install leptosfmt${NC}"
    echo "  Skipping Leptos formatting check..."
fi

# Standard rustfmt check
echo "  Checking rustfmt..."
cargo fmt -- --check || {
    echo "${RED}âŒ Code formatting issues found${NC}"
    echo "${YELLOW}   Fix with: cargo fmt${NC}"
    CHECKS_FAILED=1
}

if [ $CHECKS_FAILED -eq 0 ]; then
    echo "${GREEN}  âœ… rustfmt OK${NC}"
fi

# ============================================================================
# 2. WASM Compilation Check
# ============================================================================
echo ""
echo "${BLUE}ğŸ”§ Checking WASM compilation...${NC}"

cargo check --target wasm32-unknown-unknown --quiet 2>&1 | head -20 || {
    echo "${RED}âŒ WASM compilation check failed${NC}"
    echo "${YELLOW}   Run: cargo check --target wasm32-unknown-unknown${NC}"
    CHECKS_FAILED=1
}

if [ $CHECKS_FAILED -eq 0 ]; then
    echo "${GREEN}âœ… WASM compilation OK${NC}"
fi

# ============================================================================
# 3. Clippy Lints
# ============================================================================
echo ""
echo "${BLUE}ğŸ” Running clippy...${NC}"

cargo clippy --target wasm32-unknown-unknown --quiet -- -D warnings 2>&1 | head -30 || {
    echo "${RED}âŒ Clippy found issues${NC}"
    echo "${YELLOW}   Run: cargo clippy --target wasm32-unknown-unknown -- -D warnings${NC}"
    CHECKS_FAILED=1
}

if [ $CHECKS_FAILED -eq 0 ]; then
    echo "${GREEN}âœ… Clippy checks passed${NC}"
fi

# ============================================================================
# 4. Code Quality Checks
# ============================================================================
echo ""
echo "${BLUE}ğŸ” Checking for common mistakes...${NC}"

# Check for unwrap() outside test code
echo "  Checking for unwrap() usage..."
UNWRAP_COUNT=$(git diff --cached --diff-filter=ACM -U0 | grep -E '^\+.*unwrap\(\)' | grep -v test | grep -v '//' | wc -l || true)
if [ "$UNWRAP_COUNT" -gt 0 ]; then
    echo "${YELLOW}  âš ï¸  Found $UNWRAP_COUNT new unwrap() calls${NC}"
    echo "     Consider using expect() with descriptive messages or proper error handling"
    git diff --cached --diff-filter=ACM -U0 | grep -E '^\+.*unwrap\(\)' | grep -v test | head -5 || true
fi

# Check for println! or dbg! in production code
echo "  Checking for debug statements..."
DEBUG_COUNT=$(git diff --cached --diff-filter=ACM -U0 | grep -E '^\+.*(println!|dbg!)' | grep -v test | grep -v '//' | wc -l || true)
if [ "$DEBUG_COUNT" -gt 0 ]; then
    echo "${YELLOW}  âš ï¸  Found $DEBUG_COUNT debug statements (println!/dbg!)${NC}"
    echo "     Use log::info!, log::debug!, or log::error! instead"
    git diff --cached --diff-filter=ACM -U0 | grep -E '^\+.*(println!|dbg!)' | grep -v test | head -5 || true
fi

# Check for TODO/FIXME comments
echo "  Checking for TODO/FIXME comments..."
TODO_COUNT=$(git diff --cached --diff-filter=ACM -U0 | grep -E '^\+.*(TODO|FIXME)' | wc -l || true)
if [ "$TODO_COUNT" -gt 0 ]; then
    echo "${BLUE}  â„¹ï¸  Found $TODO_COUNT new TODO/FIXME comments${NC}"
    git diff --cached --diff-filter=ACM -U0 | grep -E '^\+.*(TODO|FIXME)' | head -5 || true
fi

echo "${GREEN}  âœ… Code quality checks complete${NC}"

# ============================================================================
# 5. Module Declaration Checks
# ============================================================================
echo ""
echo "${BLUE}ğŸ” Checking module declarations...${NC}"

# Find all new .rs files
NEW_RS_FILES=$(git diff --cached --name-only --diff-filter=A | grep '\.rs$' | grep -v mod.rs | grep -v main.rs | grep -v lib.rs || true)

if [ -n "$NEW_RS_FILES" ]; then
    echo "  Checking if new files are declared in mod.rs..."
    MOD_ISSUES=0

    for file in $NEW_RS_FILES; do
        # Get directory and filename
        dir=$(dirname "$file")
        filename=$(basename "$file" .rs)
        mod_file="$dir/mod.rs"

        if [ -f "$mod_file" ]; then
            # Check if module is declared
            if ! grep -q "pub mod $filename" "$mod_file"; then
                echo "${YELLOW}  âš ï¸  $filename not declared in $mod_file${NC}"
                echo "     Add: pub mod $filename;"
                MOD_ISSUES=1
            fi
        else
            echo "${YELLOW}  âš ï¸  No mod.rs found in $dir${NC}"
            echo "     Create $mod_file and declare modules"
            MOD_ISSUES=1
        fi
    done

    if [ $MOD_ISSUES -eq 0 ]; then
        echo "${GREEN}  âœ… All new modules are properly declared${NC}"
    fi
else
    echo "${GREEN}  â­ï¸  No new Rust files to check${NC}"
fi

# ============================================================================
# 6. Dependency Checks
# ============================================================================
echo ""
echo "${BLUE}ğŸ” Checking dependencies...${NC}"

# Check if Cargo.toml was modified
if git diff --cached --name-only | grep -q "Cargo.toml"; then
    echo "  Cargo.toml modified - checking for non-WASM dependencies..."

    # Common non-WASM crates to warn about
    NON_WASM_CRATES="tokio,async-std,std::fs,std::net"

    for crate in $(echo $NON_WASM_CRATES | tr ',' ' '); do
        if git diff --cached Cargo.toml | grep -q "^\+.*$crate"; then
            echo "${YELLOW}  âš ï¸  Added dependency on '$crate' - verify WASM compatibility${NC}"
        fi
    done
fi

echo "${GREEN}âœ… Dependency checks complete${NC}"

# ============================================================================
# 7. TailwindCSS Configuration Checks
# ============================================================================
echo ""
echo "${BLUE}ğŸ¨ Checking TailwindCSS configuration...${NC}"

# Check if tailwind.config.js was modified
if git diff --cached --name-only | grep -q "tailwind.config.js"; then
    echo "  tailwind.config.js modified - validating..."

    # Check if content includes Rust files
    if ! grep -q '"./src/\*\*/\*.rs"' tailwind.config.js 2>/dev/null; then
        echo "${YELLOW}  âš ï¸  Tailwind content should include './src/**/*.rs'${NC}"
    fi

    # Check if daisyUI is in plugins
    if ! grep -q 'require.*daisyui' tailwind.config.js 2>/dev/null; then
        echo "${YELLOW}  âš ï¸  daisyUI plugin not found in tailwind.config.js${NC}"
    fi
fi

# Check if package.json was modified
if git diff --cached --name-only | grep -q "package.json"; then
    echo "  package.json modified - checking versions..."

    # Check for correct Tailwind version
    if git diff --cached package.json | grep -q '"tailwindcss"'; then
        if ! git diff --cached package.json | grep -q '"tailwindcss".*"3\.4'; then
            echo "${YELLOW}  âš ï¸  TailwindCSS should be version ^3.4.18${NC}"
        fi
    fi

    # Check for correct DaisyUI version
    if git diff --cached package.json | grep -q '"daisyui"'; then
        if ! git diff --cached package.json | grep -q '"daisyui".*"5\.'; then
            echo "${YELLOW}  âš ï¸  DaisyUI should be version ^5.0.0${NC}"
        fi
    fi
fi

echo "${GREEN}âœ… TailwindCSS configuration OK${NC}"

# ============================================================================
# Final Summary
# ============================================================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ $CHECKS_FAILED -eq 0 ]; then
    echo "${GREEN}âœ… All pre-commit checks passed!${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 0
else
    echo "${RED}âŒ Some checks failed. Please fix the issues above.${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "To skip this hook (not recommended):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi
